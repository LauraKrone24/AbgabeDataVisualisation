<!DOCTYPE html>

<html>

    <head>
        <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css" rel="stylesheet" />
        <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js"></script>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/queue.v1.min.js"></script>
        <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>

        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    </head>

    <body >
        
        
        <div id = "Options">     
            <table >
                <tr id="tableheader">
                    <td>
                        <h5>Visualisation</h5>
                        <div id="dropdownButtonVisulisation"></div>
                    </td>
                    <td>
                         <h5>Airport</h5>
                        <div id="dropdownButtonAirlines"></div>
                    </td>
                    <td>
                        <h5>Speed</h5>
                        <div id="dropdownButtonAnimationspeed"></div>
                    </td>
                    <td>
                        <h5>Starthour</h5>
                        <div id="dropdownButtonAnimationStart"></div>
                    </td>
                    <td style="text-align:center"> 
                        <h5>Show Add Info</h5> 
                        <input type="checkbox">
                    </td>
                    <td >
                        <h5>Date and Time</h5> 
                        <div id="TimeText"></div>
                    </td>
                    
                </tr>
                <tr id="Addinfo">
                    <td> <br>
                            <h5>Depature Delay</h5>
                            <table >
                                <tr>
                                   <td>Min</td> 
                                   <td>Avg</td> 
                                   <td>Max</td> 
                                </tr>
                                <tr>
                                    <td><div id="DepMin"></div></td> 
                                    <td><div id="DepAvg"></div></td> 
                                    <td><div id="DepMax"></div></td> 
                                 </tr>
                            </table>
                    </td>
                    <td> <br>
                            <h5>Air Time Difference</h5>
                            <table >
                                <tr>
                                    <td>Min</td> 
                                    <td>Avg</td> 
                                    <td>Max</td> 
                                </tr>
                                <tr>
                                    <td><div id="ATDMin"></div></td> 
                                    <td><div id="ATDAvg"></div></td> 
                                    <td><div id="ATDMax"></div></td> 
                                </tr>
                            </table>
                    </td>
                    <td> <br>
                            <h5>Destination Delay</h5>
                            <table >
                                <tr>
                                    <td>Min</td> 
                                    <td>Avg</td> 
                                    <td>Max</td> 
                                </tr>
                                <tr>
                                    <td><div id="DestMin"></div></td> 
                                    <td><div id="DestAvg"></div></td> 
                                    <td><div id="DestMax"></div></td> 
                                </tr>
                            </table>
                    </td>
                </tr>
            </table> 
           
        </div>
        
        <div id="map"></div>
        



        <script type="text/javascript">
            var Airline="all"; 
            var AnimationSpeed = 1000;
            var StartHour=0; 
            
            d3.select("#Addinfo").style("display","none")

            var DepMin = d3.select('#DepMin')
                .append("text")
                .attr("color","beige")

            var DepAvg = d3.select('#DepAvg')
                .append("text")
                .attr("color","beige")
            var DepMax = d3.select('#DepMax')
                .append("text")
                .attr("color","beige")

            var ATDMin = d3.select('#ATDMin')
                .append("text")
                .attr("color","beige")

            var ATDAvg = d3.select('#ATDAvg')
                .append("text")
                .attr("color","beige")
            var ATDMax = d3.select('#ATDMax')
                .append("text")
                .attr("color","beige")
            
            var DestMin = d3.select('#DestMin')
                .append("text")
                .attr("color","beige")

            var DestAvg = d3.select('#DestAvg')
                .append("text")
                .attr("color","beige")
            var DestMax = d3.select('#DestMax')
                .append("text")
                .attr("color","beige")
            
            
                
            let AirlineLink = 'https://raw.githubusercontent.com/LauraKrone24/AbgabeDataVisualisation/master/Airlines.csv'

            d3.csv(AirlineLink).then(airlinedata=>{
                console.log(airlinedata)
                loadAddinfo(airlinedata)
                var dropdownButtonAirlines = d3.select("#dropdownButtonAirlines")
                    .append('select')
                    
                dropdownButtonAirlines
                    .selectAll('myOptions') 
                    .data(airlinedata)
                    .enter()
                    .append('option')
                    .text(function (d) { return d.Name; }) 
                    .attr("value", function (d) { return d.IATA; }) 

                dropdownButtonAirlines.on("change", function(d) {
                    let option = d3.select(this).property("value")
                    Airline = option;
                    loadAddinfo(airlinedata)
                    load()
                    })
                
                

            });

            d3.select("input[type=checkbox]").on("change",function(d){
                let checked = d3.select(this).property("checked")
                checked?d3.select("#Addinfo").style("display",""):d3.select("#Addinfo").style("display","none")
            })
            function loadAddinfo(airlinedata){
                d3.select("#Addinfo").style("display",d3.select("input[type=checkbox]").property("checked"))
                DepAvg.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].AvgOrgDelay)  
                DepMin.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].MinOrgDelay)
                DepMax.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].MaxOrgDelay)
                ATDAvg.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].AvgAirTimeDiff)  
                ATDMin.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].MinAirTimeDiff)
                ATDMax.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].MaxAirTimeDiff)
                DestAvg.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].AvgDestDelay)  
                DestMin.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].MinDestDelay)
                DestMax.text(airlinedata.filter(x=>{return Airline==x.IATA})[0].MaxDestDelay)
                
            }




            var dropdownButtonAnimationspeed = d3.select("#dropdownButtonAnimationspeed")
                .append('select')
                
            dropdownButtonAnimationspeed 
                .selectAll('myOptions') 
                .data([{text:"x 3600     ",value:1000},{text:"x 360",value:10000},{text:"x120",value:30000},{text:"x 60 ",value:60000}])
                .enter()
                .append('option')
                .text(function (d) { return d.text; }) 
                .attr("value", function (d) { return d.value; }) 

            dropdownButtonAnimationspeed.on("change", function(d) {
                let option = d3.select(this).property("value")
                AnimationSpeed= option;
                load()
                })

            var dropdownButtonAnimationStart = d3.select("#dropdownButtonAnimationStart")
                .append('select')
                
            dropdownButtonAnimationStart
                .selectAll('myOptions') 
                .data([{text:"00",value:0},{text:"01",value:1},{text:"02",value:2},{text:"03",value:3},{text:"04",value:4},{text:"05",value:5},{text:"06",value:6},{text:"07",value:7},{text:"08",value:8},{text:"09",value:9},{text:"10",value:10},{text:"11",value:11},{text:"12",value:12},{text:"13",value:13},{text:"14",value:14},{text:"15",value:15},{text:"16",value:16},{text:"17",value:17},{text:"18",value:18},{text:"19",value:19},{text:"20",value:20},{text:"21",value:21},{text:"22",value:22},{text:"23",value:23},{text:"Daily Avg.",value:-1}])
                .enter()
                .append('option')
                .text(function (d) { return d.text; }) 
                .attr("value", function (d) { return d.value; }) 

            dropdownButtonAnimationStart.on("change", function(d) {
                let option = d3.select(this).property("value")
                StartHour = option;
                if(StartHour!= -1)
                {
                    
                    AnimationSpeed= dropdownButtonAnimationspeed.property("value");
                    console.log("Animationspeed:"+AnimationSpeed)
                }
                load()
                })


            var dropdownButtonVisulisation = d3.select("#dropdownButtonVisulisation")
                .append('select')
                
            dropdownButtonVisulisation 
                .selectAll('myOptions') 
                .data([{text:"Delay from airlines",value:"airlines.html"},{text:"Delay at airports",value:"airports.html"},{text:"Connections",value:"connections.html"}])
                .attr("class","dropdown")
                .enter()
                .append('option')
                .text(function (d) { return d.text; }) 
                .attr("value", function (d) { return d.value; }) 

            dropdownButtonVisulisation.on("change", function(d) {
                let option = d3.select(this).property("value")
                    open(option,"_self")
                })

            var view = "map"
            mapboxgl.accessToken = 'pk.eyJ1IjoibGF1cmFrcm8iLCJhIjoiY2xmbWx0cHEzMGQwNTN4bnA1Ync1eHI5cyJ9.RbCaC98XN7LIzk4pde9YbA'; 

            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v9',
                zoom: 3,
                center: [-104.386330, 43.753746]
            });


            map.on("viewreset", load);
            map.on("moveend", load);
            
           

            var canvas = map.getCanvasContainer();
            var svg = d3.select(canvas).append("svg");

            
                            
            var TimeText = d3.select('#TimeText')
                        .append("text")
                        .attr("color","beige")
            

            

            load()
            function load()
            {

                TimeText.interrupt()
                let flights = 'https://gist.githubusercontent.com/florianeichin/cfa1705e12ebd75ff4c321427126ccee/raw/c86301a0e5d0c1757d325424b8deec04cc5c5ca9/flights_all_cleaned.csv'
                
                svg.selectAll("*").remove()
                
                d3.csv(flights,(x)=> {
                
                if (!x.ORIGIN_AIRPORT_POS.includes('nan') && !x.DESTINATION_AIRPORT_POS.includes('nan')) {
                x.DESTINATION_AIRPORT_POS = JSON.parse(x.DESTINATION_AIRPORT_POS.replace(/\'/g, "\""))
                x.ORIGIN_AIRPORT_POS = JSON.parse(x.ORIGIN_AIRPORT_POS.replace(/\'/g, "\""))
                x.Hour = Number(x.SCHEDULED_DEPARTURE.substring(11,13)) +Number(x.SCHEDULED_DEPARTURE.substring(14,16))/60
                 return x}}).then(data=>{
                    
                    data = data.filter(x => { return  (x.Hour*1)>= StartHour})
                    Airline!="all"? data = data.filter(x=>{return Airline==x.AIRLINE}): 
                    console.log(data)
                    if (StartHour ==-1){
                        AnimationSpeed =  1000000000000; 
                    }
                    
                    
                    var myColor = d3.scaleLinear().domain([-60,0,60])
                    .range(["green","white", "red"])
                    

                    var x = d3.scaleLinear()
                        .domain([0, 5])
                        .range([0, 1000]);

                    var y = d3.scaleLinear()
                        .domain([10, 0])
                        .range([0, 500])

                    var line = d3.line()
                        .x((d) => x(d.x))
                        .y((d) => y(d.y))
                    
                    g = svg.selectAll("circle")
                        .data(data)
                        .enter()
                        .append('g')

                    g.append("circle")
                        .attr("r", 5)
                        .attr("cx", d => { return projectPoint(d.ORIGIN_AIRPORT_POS.lon, d.ORIGIN_AIRPORT_POS.lat).x })
                        .attr("cy", d => { return projectPoint(d.ORIGIN_AIRPORT_POS.lon, d.ORIGIN_AIRPORT_POS.lat).y })
                        .style('fill', d => { return myColor(d.DEPARTURE_DELAY) })
                        .style("opacity", 0)

                        .transition()
                        .style("opacity", 1)
                        .delay(function (d, i) { return (d.Hour-StartHour) * AnimationSpeed })

                        .transition()
                        .duration(function (d, i) { return (d.ELAPSED_TIME/60) * AnimationSpeed })
                        .attr("cx", d => { return projectPoint(d.DESTINATION_AIRPORT_POS.lon, d.DESTINATION_AIRPORT_POS.lat).x })
                        .attr("cy", d => { return projectPoint(d.DESTINATION_AIRPORT_POS.lon, d.DESTINATION_AIRPORT_POS.lat).y })
                        .style('fill', d => { return myColor(d.DESTINATION_DELAY) })
                        .transition()
                        .remove()

                    g.append("line")
                        .attr("x1", d => { return projectPoint(d.ORIGIN_AIRPORT_POS.lon, d.ORIGIN_AIRPORT_POS.lat).x })
                        .attr("y1", d => { return projectPoint(d.ORIGIN_AIRPORT_POS.lon, d.ORIGIN_AIRPORT_POS.lat).y })
                        .attr("x2", d => { return projectPoint(d.ORIGIN_AIRPORT_POS.lon, d.ORIGIN_AIRPORT_POS.lat).x })
                        .attr("y2", d => { return projectPoint(d.ORIGIN_AIRPORT_POS.lon, d.ORIGIN_AIRPORT_POS.lat).y })
                        .attr("stroke-width", 1)
                        .attr("stroke", d => {return  myColor(d.DEPARTURE_DELAY) })
                        .attr("stroke-dasharray", "4")
                        .style("opacity", 0)

                        .transition()
                        .style("opacity", 1)
                        .delay(function (d, i) { return (d.Hour-StartHour) * AnimationSpeed })

                        .transition()
                        .duration(function (d, i) { return (d.ELAPSED_TIME/60) * AnimationSpeed })
                        .attr("x2", d => { return projectPoint(d.DESTINATION_AIRPORT_POS.lon, d.DESTINATION_AIRPORT_POS.lat).x })
                        .attr("y2", d => { return projectPoint(d.DESTINATION_AIRPORT_POS.lon, d.DESTINATION_AIRPORT_POS.lat).y })
                        .attr("stroke", d => { return  myColor(d.DESTINATION_DELAY) })
                        .transition()
                        .remove()
                   

                    
                    if(StartHour==-1)
                    {
                        TimeText.text("2015-01-01")
                           
                    }
                    else{
                        for(let i = StartHour; i<24;i++)
                         {
                       
                            if(i<=9){
                                TimeText.transition()
                                .delay((i-StartHour) * AnimationSpeed  )
                                .text("2015-01-01 0"+i+":00:00")
                                .duration(AnimationSpeed)
                                
                            }else{
                                TimeText.transition()
                                .delay((i-StartHour) * AnimationSpeed  )
                                .duration(AnimationSpeed)
                                .text("2015-01-01 "+i+":00:00")
                                
                            }
                        }
                    }

                    
                   
                 })

            }

            function project(d) {
                return map.project(new mapboxgl.LngLat(d[0], d[1]));
            }

            
            function projectPoint(lon, lat) {
                var point = map.project(new mapboxgl.LngLat(lon, lat));
                return point

            }
            
        </script>
    </body>

    </html>