<!DOCTYPE html>

<html>

    <head>
        <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css" rel="stylesheet" />
        <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js"></script>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/queue.v1.min.js"></script>
        <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>

        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    </head>

    <body >
        
        
        <div id = "Options">     
            <table >
                <tr id="tableheader">
                    <td>
                        <h5>Visualisation</h5>
                        <div id="dropdownButtonVisulisation"></div>
                    </td>
                   
                    
                    
                    
                </tr>
                
            </table> 
           
        </div>
        
        <div id="chord"></div>
        



        <script type="text/javascript">
            var dropdownButtonVisulisation = d3.select("#dropdownButtonVisulisation")
                .append('select')
                
            dropdownButtonVisulisation 
                .selectAll('myOptions') 
                .data([{text:"Connections",value:"connections.html"},{text:"Delay from airlines",value:"airlines.html"},{text:"Delay at airports",value:"airports.html"}])
                .attr("class","dropdown")
                .enter()
                .append('option')
                .text(function (d) { return d.text; }) 
                .attr("value", function (d) { return d.value; }) 

            dropdownButtonVisulisation.on("change", function(d) {
                let option = d3.select(this).property("value")
                    open(option,"_self")
                })   

            load()
            function load()
            {

                
                let flights = 'https://gist.githubusercontent.com/florianeichin/cfa1705e12ebd75ff4c321427126ccee/raw/c86301a0e5d0c1757d325424b8deec04cc5c5ca9/flights_all_cleaned.csv'
                
                
                
                d3.csv(flights,(x)=> {
                
                if (!x.ORIGIN_AIRPORT_POS.includes('nan') && !x.DESTINATION_AIRPORT_POS.includes('nan')) {
                x.DESTINATION_AIRPORT_POS = JSON.parse(x.DESTINATION_AIRPORT_POS.replace(/\'/g, "\""))
                x.ORIGIN_AIRPORT_POS = JSON.parse(x.ORIGIN_AIRPORT_POS.replace(/\'/g, "\""))
                x.Hour = Number(x.SCHEDULED_DEPARTURE.substring(11,13)) +Number(x.SCHEDULED_DEPARTURE.substring(14,16))/60
                 return x}}).then(data=>{
                    
                    console.log(data)
                    
                    
                    var myColor = d3.scaleLinear().domain([-60,0,60])
                    .range(["green","white", "red"])
                    
                 

                    // create the svg area
                    var svg = d3.select("#chord")
                    .append("svg")
                        .attr("width", 440)
                        .attr("height", 440)
                    .append("g")
                        .attr("transform", "translate(220,220)")

                    // create input data: a square matrix that provides flow between entities
                    var matrix = [
                    [11975,  5871, 8916, 2868],
                    [ 1951, 10048, 2060, 6171],
                    [ 8010, 16145, 8090, 8045],
                    [ 1013,   990,  940, 6907]
                    ];

                    // give this matrix to d3.chord(): it will calculates all the info we need to draw arc and ribbon
                    var res = d3.chord()
                        .padAngle(0.05)     // padding between entities (black arc)
                        .sortSubgroups(d3.descending)
                        (matrix)

                    // add the groups on the inner part of the circle
                    svg
                    .datum(res)
                    .append("g")
                    .selectAll("g")
                    .data(function(d) { return d.groups; })
                    .enter()
                    .append("g")
                    .append("path")
                        .style("fill", "grey")
                        .style("stroke", "black")
                        .attr("d", d3.arc()
                        .innerRadius(200)
                        .outerRadius(210)
                        )

                    // Add the links between groups
                    svg
                    .datum(res)
                    .append("g")
                    .selectAll("path")
                    .data(function(d) { return d; })
                    .enter()
                    .append("path")
                        .attr("d", d3.ribbon()
                        .radius(200)
                        )
                        .style("fill", "#69b3a2")
                        .style("stroke", "black");


                    

                    

                   
                   

                  

                    
                   
                 })

            }

          
            
        </script>
    </body>

    </html>